# üìö Documentation des Scripts SQL

Ce document explique tous les scripts SQL du projet et leur utilisation.

## üéØ Pour Dupliquer la Base de Donn√©es : Utiliser `supabase_complete_schema.sql`

**Si vous voulez dupliquer compl√®tement la base de donn√©es, utilisez uniquement :**

### ‚úÖ `supabase_complete_schema.sql` 

**C'est le fichier ma√Ætre qui contient TOUT !**

Ce fichier consolide tous les scripts SQL n√©cessaires dans le bon ordre :

1. **Tables** : profiles, questions, comments (avec toutes les colonnes)
2. **Index** : pour optimiser les performances
3. **Row Level Security (RLS)** : toutes les politiques de s√©curit√©
4. **Fonctions et Triggers** : cr√©ation automatique des profils
5. **Politiques de stockage** : pour les avatars

#### Utilisation :

1. Cr√©ez un nouveau projet Supabase
2. Allez dans **SQL Editor**
3. Copiez-collez le contenu de `supabase_complete_schema.sql`
4. Ex√©cutez le script
5. Allez dans **Storage** ‚Üí Cr√©ez un bucket public nomm√© `avatars`
6. C'est termin√© ! ‚úÖ

---

## üìÇ Fichiers SQL Existants (Historique)

Les fichiers suivants ont √©t√© utilis√©s pour construire la base de donn√©es au fur et √† mesure du d√©veloppement. Ils sont conserv√©s pour r√©f√©rence, mais **vous n'avez pas besoin de les ex√©cuter** si vous utilisez `supabase_complete_schema.sql`.

### 1. `supabase_schema.sql` (Base initiale)

**Contenu :**
- Table `profiles` (sans is_admin)
- Table `questions` (sans is_answered, updated_at, last_editor_id)
- Politiques RLS de base pour profiles et questions
- Fonction `handle_new_user()` et trigger

**Probl√®me :** Incomplet, manque plusieurs colonnes ajout√©es plus tard.

### 2. `supabase_migration_answered.sql` (Migration)

**Contenu :**
- Ajoute la colonne `is_answered` √† la table questions
- Ajoute les politiques de mise √† jour pour le propri√©taire et les admins

**Probl√®me :** Suppose que is_admin existe d√©j√† dans profiles (mais ce n'est pas le cas dans schema.sql).

### 3. `supabase_add_tracking_columns.sql` (Migration)

**Contenu :**
- Ajoute `updated_at` et `last_editor_id` aux tables questions et comments
- Cr√©e/met √† jour les politiques RLS pour les commentaires (avec permissions admin)

**Probl√®me :** Suppose que la table comments existe d√©j√†, mais elle n'est jamais cr√©√©e dans les scripts pr√©c√©dents ! ‚ùå

### 4. `supabase_fix_rls.sql` (Correction)

**Contenu :**
- Supprime et recr√©e les politiques RLS pour √©viter les conflits
- Politiques UPDATE pour profiles et questions

**Usage :** Corrige les politiques en cas de conflit.

### 5. `supabase_storage_policies.sql` (Stockage)

**Contenu :**
- Politiques RLS pour le bucket `avatars`
- Permissions upload/update/delete/view

**Note :** N√©cessite de cr√©er le bucket manuellement d'abord.

### 6. `supabase_admin_delete_comments.sql` (Permission Admin)

**Contenu :**
- Politique DELETE pour les commentaires
- Permet aux utilisateurs de supprimer leurs propres commentaires
- Permet aux admins de supprimer tous les commentaires

**D√©pendance :** N√©cessite que is_admin existe dans profiles.

---

## üóÑÔ∏è Fichiers Utilitaires (Maintenance)

### `supabase_reset_data.sql`

**Usage :** Vide toutes les questions et commentaires tout en gardant les profils utilisateurs.

**Utilisation :**
```sql
-- Ex√©cuter dans SQL Editor
-- Supprime toutes les questions et commentaires
-- Les profils sont conserv√©s
```

**‚ö†Ô∏è ATTENTION :** Action irr√©versible !

### `supabase_reset_storage.sql`

**Usage :** Script pour nettoyer les avatars du bucket storage.

**Par d√©faut :** Ne supprime rien (liste uniquement les fichiers).

**Options :**
- Supprimer TOUS les avatars
- Supprimer sauf certains utilisateurs sp√©cifiques

**‚ö†Ô∏è ATTENTION :** D√©commentez les sections appropri√©es avant d'ex√©cuter.

---

## üîç Probl√®mes Identifi√©s dans les Scripts Historiques

### ‚ùå Table `comments` jamais cr√©√©e

**Probl√®me :** La table comments est utilis√©e partout dans le code, mais aucun script SQL ne la cr√©e !

**Solution :** Ajout√©e dans `supabase_complete_schema.sql`.

**Structure reconstruite depuis le code :**
```sql
CREATE TABLE comments (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  question_id bigint REFERENCES questions(id) ON DELETE CASCADE NOT NULL,
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  content text NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamptz DEFAULT now(),
  last_editor_id uuid REFERENCES profiles(id)
);
```

### ‚ùå Colonne `is_admin` jamais cr√©√©e

**Probl√®me :** Plusieurs scripts r√©f√©rencent `profiles.is_admin` mais aucun ne cr√©e cette colonne !

**Solution :** Ajout√©e dans `supabase_complete_schema.sql`.

```sql
is_admin boolean DEFAULT false NOT NULL
```

### ‚ùå Ordre d'ex√©cution probl√©matique

**Probl√®me :** Les scripts r√©f√©rencent des colonnes qui n'existent pas encore si on les ex√©cute dans l'ordre du README.

**Exemple :**
- `supabase_migration_answered.sql` utilise `is_admin`
- Mais `is_admin` n'est jamais cr√©√© dans `supabase_schema.sql`

**Solution :** `supabase_complete_schema.sql` cr√©e tout dans le bon ordre.

---

## üìä Structure Compl√®te de la Base de Donn√©es

### Table : `profiles`

| Colonne | Type | Description |
|---------|------|-------------|
| id | uuid | R√©f√©rence √† auth.users (PK) |
| username | text | Nom d'utilisateur (unique) |
| avatar_url | text | URL de l'avatar |
| **is_admin** | boolean | Est administrateur ? (d√©faut: false) |
| created_at | timestamptz | Date de cr√©ation |

### Table : `questions`

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | ID auto-incr√©ment√© (PK) |
| title | text | Titre de la question |
| description | text | Description en Markdown |
| user_id | uuid | R√©f√©rence √† profiles |
| **is_answered** | boolean | Question r√©pondue ? (d√©faut: false) |
| created_at | timestamptz | Date de cr√©ation |
| **updated_at** | timestamptz | Date de modification |
| **last_editor_id** | uuid | Dernier √©diteur (r√©f√©rence √† profiles) |
| tags | text[] | Liste de tags |

### Table : `comments`

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | ID auto-incr√©ment√© (PK) |
| question_id | bigint | R√©f√©rence √† questions |
| user_id | uuid | R√©f√©rence √† profiles |
| content | text | Contenu du commentaire |
| created_at | timestamptz | Date de cr√©ation |
| **updated_at** | timestamptz | Date de modification |
| **last_editor_id** | uuid | Dernier √©diteur (r√©f√©rence √† profiles) |

**Note :** Les colonnes en **gras** sont celles qui ont √©t√© ajout√©es apr√®s la cr√©ation initiale.

---

## üöÄ R√©sum√© - Que Faire ?

### ‚úÖ Pour une nouvelle installation :

1. Utilisez `supabase_complete_schema.sql`
2. Cr√©ez le bucket `avatars` manuellement
3. C'est termin√© !

### üîÑ Pour une base de donn√©es existante :

Si vous avez d√©j√† une base de donn√©es en production :
- **NE PAS** ex√©cuter `supabase_complete_schema.sql` (cela cr√©erait des doublons)
- Utilisez les scripts de migration individuels si n√©cessaire
- Ou exportez vos donn√©es, recr√©ez avec le script complet, puis r√©importez

### üóëÔ∏è Pour nettoyer et recommencer :

1. Supprimez toutes les tables manuellement dans Supabase
2. Ex√©cutez `supabase_complete_schema.sql`
3. Recr√©ez le bucket `avatars`

---

## üí° Conseils

- **Backups :** Toujours faire une sauvegarde avant de modifier la structure
- **Tests :** Testez d'abord sur un projet Supabase de d√©veloppement
- **is_admin :** D√©finissez manuellement les admins via Table Editor apr√®s inscription

---

**Cr√©√© le :** 2025-12-12  
**Auteur :** Thomas TIROLE pour EMT

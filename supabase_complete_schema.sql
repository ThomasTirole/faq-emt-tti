-- ============================================
-- Script SQL Complet pour la Base de Donn√©es
-- Plateforme de Questions-R√©ponses pour √âtudiants
-- ============================================
-- Ce script cr√©e toutes les tables, colonnes, politiques RLS et fonctions
-- n√©cessaires pour dupliquer la base de donn√©es en entier.
--
-- ATTENTION : Ce script doit √™tre ex√©cut√© sur une base de donn√©es vide
-- ou apr√®s avoir supprim√© toutes les tables existantes.
--
-- Pr√©requis :
-- 1. Projet Supabase cr√©√©
-- 2. Bucket de stockage 'avatars' cr√©√© en mode public via l'interface Supabase
--
-- Ordre d'ex√©cution :
-- 1. Ex√©cuter ce script dans l'√©diteur SQL de Supabase
-- 2. Le bucket 'avatars' doit √™tre cr√©√© manuellement via Storage ‚Üí Create bucket
-- ============================================


-- ============================================
-- SECTION 1 : CR√âATION DES TABLES
-- ============================================

-- -----------------------------------------------
-- Table: profiles
-- Description: Profils utilisateurs publics
-- -----------------------------------------------
CREATE TABLE IF NOT EXISTS profiles (
  id uuid REFERENCES auth.users ON DELETE CASCADE NOT NULL PRIMARY KEY,
  username text UNIQUE,
  avatar_url text,
  is_admin boolean DEFAULT false NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- -----------------------------------------------
-- Table: questions
-- Description: Questions pos√©es par les utilisateurs
-- -----------------------------------------------
CREATE TABLE IF NOT EXISTS questions (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title text NOT NULL,
  description text NOT NULL, -- Contenu Markdown
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  is_answered boolean DEFAULT false NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamptz DEFAULT now(),
  last_editor_id uuid REFERENCES profiles(id),
  tags text[]
);

-- -----------------------------------------------
-- Table: comments
-- Description: Commentaires sur les questions
-- -----------------------------------------------
CREATE TABLE IF NOT EXISTS comments (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  question_id bigint REFERENCES questions(id) ON DELETE CASCADE NOT NULL,
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
  content text NOT NULL,
  created_at timestamptz DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamptz DEFAULT now(),
  last_editor_id uuid REFERENCES profiles(id)
);


-- ============================================
-- SECTION 2: CR√âATION DES INDEX
-- ============================================

-- Index pour am√©liorer les performances des requ√™tes fr√©quentes
CREATE INDEX IF NOT EXISTS idx_questions_user_id ON questions(user_id);
CREATE INDEX IF NOT EXISTS idx_questions_created_at ON questions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_questions_is_answered ON questions(is_answered);
CREATE INDEX IF NOT EXISTS idx_comments_question_id ON comments(question_id);
CREATE INDEX IF NOT EXISTS idx_comments_user_id ON comments(user_id);
CREATE INDEX IF NOT EXISTS idx_comments_created_at ON comments(created_at);


-- ============================================
-- SECTION 3: ROW LEVEL SECURITY (RLS)
-- ============================================

-- Activer RLS sur toutes les tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE comments ENABLE ROW LEVEL SECURITY;

-- -----------------------------------------------
-- Politiques RLS pour la table: profiles
-- -----------------------------------------------

-- Tout le monde peut voir tous les profils
DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON profiles;
CREATE POLICY "Public profiles are viewable by everyone." 
  ON profiles FOR SELECT 
  USING (true);

-- Les utilisateurs peuvent cr√©er leur propre profil
DROP POLICY IF EXISTS "Users can insert their own profile." ON profiles;
CREATE POLICY "Users can insert their own profile." 
  ON profiles FOR INSERT 
  WITH CHECK (auth.uid() = id);

-- Les utilisateurs peuvent modifier leur propre profil
DROP POLICY IF EXISTS "Users can update own profile." ON profiles;
CREATE POLICY "Users can update own profile." 
  ON profiles FOR UPDATE 
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);

-- -----------------------------------------------
-- Politiques RLS pour la table: questions
-- -----------------------------------------------

-- Tout le monde peut voir toutes les questions
DROP POLICY IF EXISTS "Questions are viewable by everyone." ON questions;
CREATE POLICY "Questions are viewable by everyone." 
  ON questions FOR SELECT 
  USING (true);

-- Les utilisateurs authentifi√©s peuvent cr√©er des questions
DROP POLICY IF EXISTS "Authenticated users can create questions." ON questions;
CREATE POLICY "Authenticated users can create questions." 
  ON questions FOR INSERT 
  WITH CHECK (auth.role() = 'authenticated');

-- Le propri√©taire d'une question peut la modifier
DROP POLICY IF EXISTS "Question owner can update question." ON questions;
CREATE POLICY "Question owner can update question." 
  ON questions FOR UPDATE 
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Les administrateurs peuvent modifier n'importe quelle question
DROP POLICY IF EXISTS "Admins can update any question." ON questions;
CREATE POLICY "Admins can update any question." 
  ON questions FOR UPDATE 
  USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  );

-- Les utilisateurs peuvent supprimer leurs propres questions
DROP POLICY IF EXISTS "Users can delete own questions." ON questions;
CREATE POLICY "Users can delete own questions." 
  ON questions FOR DELETE 
  USING (auth.uid() = user_id);

-- Les administrateurs peuvent supprimer n'importe quelle question
DROP POLICY IF EXISTS "Admins can delete any question." ON questions;
CREATE POLICY "Admins can delete any question." 
  ON questions FOR DELETE 
  USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  );

-- -----------------------------------------------
-- Politiques RLS pour la table: comments
-- -----------------------------------------------

-- Tout le monde peut voir tous les commentaires
DROP POLICY IF EXISTS "Comments are viewable by everyone." ON comments;
CREATE POLICY "Comments are viewable by everyone." 
  ON comments FOR SELECT 
  USING (true);

-- Les utilisateurs authentifi√©s peuvent cr√©er des commentaires
DROP POLICY IF EXISTS "Authenticated users can create comments." ON comments;
CREATE POLICY "Authenticated users can create comments." 
  ON comments FOR INSERT 
  WITH CHECK (auth.role() = 'authenticated');

-- Les utilisateurs peuvent modifier leurs propres commentaires
DROP POLICY IF EXISTS "Users can update own comments." ON comments;
CREATE POLICY "Users can update own comments." 
  ON comments FOR UPDATE 
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Les administrateurs peuvent modifier n'importe quel commentaire
DROP POLICY IF EXISTS "Admins can update any comment." ON comments;
CREATE POLICY "Admins can update any comment." 
  ON comments FOR UPDATE 
  USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  );

-- Les utilisateurs peuvent supprimer leurs propres commentaires OU les admins peuvent supprimer n'importe quel commentaire
DROP POLICY IF EXISTS "Users can delete own comments or admins can delete any." ON comments;
CREATE POLICY "Users can delete own comments or admins can delete any." 
  ON comments FOR DELETE 
  USING (
    auth.uid() = user_id OR
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND is_admin = true
    )
  );


-- ============================================
-- SECTION 4: FONCTIONS ET TRIGGERS
-- ============================================

-- -----------------------------------------------
-- Fonction: handle_new_user
-- Description: Cr√©e automatiquement un profil lors de l'inscription
-- -----------------------------------------------
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, username, avatar_url, is_admin)
  VALUES (
    new.id, 
    new.raw_user_meta_data->>'username', 
    new.raw_user_meta_data->>'avatar_url',
    false
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- -----------------------------------------------
-- Trigger: on_auth_user_created
-- Description: D√©clenche la cr√©ation du profil lors de l'inscription
-- -----------------------------------------------
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();


-- ============================================
-- SECTION 5: POLITIQUES DE STOCKAGE (STORAGE)
-- ============================================
-- Note: Le bucket 'avatars' doit √™tre cr√©√© manuellement via l'interface Supabase
-- Storage ‚Üí Create bucket ‚Üí Name: "avatars" ‚Üí Public: Yes
-- ============================================

-- Permettre aux utilisateurs authentifi√©s d'uploader leur propre avatar
DROP POLICY IF EXISTS "Users can upload own avatar" ON storage.objects;
CREATE POLICY "Users can upload own avatar" 
  ON storage.objects FOR INSERT 
  TO authenticated
  WITH CHECK (
    bucket_id = 'avatars' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );

-- Permettre aux utilisateurs authentifi√©s de mettre √† jour leur propre avatar
DROP POLICY IF EXISTS "Users can update own avatar" ON storage.objects;
CREATE POLICY "Users can update own avatar" 
  ON storage.objects FOR UPDATE 
  TO authenticated
  USING (
    bucket_id = 'avatars' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );

-- Permettre aux utilisateurs authentifi√©s de supprimer leur propre avatar
DROP POLICY IF EXISTS "Users can delete own avatar" ON storage.objects;
CREATE POLICY "Users can delete own avatar" 
  ON storage.objects FOR DELETE 
  TO authenticated
  USING (
    bucket_id = 'avatars' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );

-- Permettre √† tout le monde de voir tous les avatars
DROP POLICY IF EXISTS "Public can view avatars" ON storage.objects;
CREATE POLICY "Public can view avatars" 
  ON storage.objects FOR SELECT 
  TO public
  USING (bucket_id = 'avatars');


-- ============================================
-- SECTION 6: V√âRIFICATION ET R√âSUM√â
-- ============================================

-- Afficher un r√©sum√© des tables cr√©√©es
DO $$
BEGIN
  RAISE NOTICE '‚úÖ Script d''initialisation termin√© !';
  RAISE NOTICE '';
  RAISE NOTICE 'üìä Tables cr√©√©es :';
  RAISE NOTICE '   - profiles (avec colonne is_admin)';
  RAISE NOTICE '   - questions (avec is_answered, updated_at, last_editor_id)';
  RAISE NOTICE '   - comments (avec updated_at, last_editor_id)';
  RAISE NOTICE '';
  RAISE NOTICE 'üîí Row Level Security (RLS) activ√© sur toutes les tables';
  RAISE NOTICE '';
  RAISE NOTICE '‚öôÔ∏è  Fonctions et Triggers cr√©√©s :';
  RAISE NOTICE '   - handle_new_user() : cr√©ation automatique des profils';
  RAISE NOTICE '   - on_auth_user_created : trigger sur auth.users';
  RAISE NOTICE '';
  RAISE NOTICE 'üìÅ Politiques de stockage configur√©es pour le bucket "avatars"';
  RAISE NOTICE '';
  RAISE NOTICE '‚ö†Ô∏è  N''oubliez pas de :';
  RAISE NOTICE '   1. Cr√©er le bucket "avatars" en mode PUBLIC via Storage';
  RAISE NOTICE '   2. D√©finir is_admin = true pour les administrateurs';
  RAISE NOTICE '';
  RAISE NOTICE 'üöÄ La base de donn√©es est pr√™te √† l''emploi !';
END $$;
